<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sticker Pack Game</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  * {
    box-sizing: border-box;
  }

  body {
    font-family: Arial, sans-serif;
    background: #f5f5f5;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    touch-action: pan-y;
    overflow-y: auto;
    min-height: 100vh;
  }

  /* Auth styles */
  #auth-box {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.98);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 20px;
  }

  #auth-box h2 {
    margin-bottom: 20px;
    color: #333;
  }

  #auth-box input {
    width: 100%;
    max-width: 300px;
    padding: 12px;
    margin: 8px 0;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 16px;
  }

  #auth-box button {
    width: 100%;
    max-width: 300px;
    padding: 12px;
    margin: 8px 0;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    cursor: pointer;
  }

  #auth-box button:active {
    background: #45a049;
  }

  #auth-box button.secondary {
    background: #2196F3;
  }

  #auth-box button.secondary:active {
    background: #1976D2;
  }

  #auth-status {
    margin-top: 10px;
    color: #666;
    font-size: 14px;
    text-align: center;
    min-height: 20px;
  }

  body.locked {
    overflow: hidden;
  }

  body.locked #sticker-area,
  body.locked #open-pack,
  body.locked header button:not(#logout-btn) {
    opacity: 0.3;
    pointer-events: none;
  }

  #logout-btn {
    background: #ff6b6b;
    color: white;
  }

  #logout-btn:active {
    background: #ff4757;
  }

  #welcome-message {
    font-weight: bold;
    padding: 8px 12px;
    background: white;
    border-radius: 4px;
    border: 1px solid #999;
    min-width: 120px;
    text-align: center;
  }

  /* Main game styles */
  header {
    width: 100%;
    background: #eee;
    padding: 10px;
    display: flex;
    justify-content: center;
    gap: 10px;
    align-items: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    flex-wrap: wrap;
    position: relative;
    z-index: 100;
  }

  header button {
    font-size: 14px;
    padding: 12px 16px;
    cursor: pointer;
    min-height: 44px;
    min-width: 44px;
    border: 1px solid #999;
    background: #fff;
    border-radius: 4px;
    font-weight: 500;
  }

  header button:active {
    background: #ddd;
  }

  #coins, #packs {
    font-weight: bold;
    font-size: 14px;
    padding: 8px 12px;
    background: #fff;
    border-radius: 4px;
    border: 1px solid #999;
    min-width: 120px;
    text-align: center;
  }

  #sticker-area {
    margin-top: 20px;
    width: 95%;
    max-width: 800px;
    height: 60vh;
    min-height: 300px;
    background: #fff;
    border: 1px solid #ccc;
    position: relative;
    overflow: hidden;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .sticker-card {
    width: 160px;
    height: 240px;
    border: 2px solid #333;
    background: #ddd;
    position: absolute;
    transform-style: preserve-3d;
    transition: transform 0.5s, left 0.8s ease-out, top 0.8s ease-out;
    user-select: none;
    touch-action: none;
    cursor: pointer;
    box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
    border-radius: 8px;
  }

  .sticker-card:active {
    transform: scale(0.95);
  }

  .sticker-card.flipped {
    transform: rotateY(180deg) !important;
  }

  .sticker-card.flipped:active {
    transform: rotateY(180deg) scale(0.95) !important;
  }

  .sticker-card.stacked {
    z-index: 10;
  }

  .sticker-card.spread {
    z-index: 1;
  }

  .sticker-front, .sticker-back {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 48px;
    font-weight: bold;
    border-radius: 6px;
  }

  .sticker-front {
    background: linear-gradient(45deg, #ff6b6b, #ffa500);
    color: white;
  }

  .sticker-back {
    transform: rotateY(180deg);
    flex-direction: column;
    background: white;
    overflow: hidden;
    padding: 10px;
  }

  .sticker-back img {
    max-width: 140px;
    max-height: 190px;
    object-fit: contain;
    margin-bottom: 5px;
    transition: transform 0.3s;
  }

  .sticker-back img.landscape {
    transform: rotate(90deg);
    max-width: 190px;
    max-height: 140px;
  }

  .sticker-back .card-number {
    font-size: 18px;
    font-weight: bold;
    margin-top: 5px;
  }

  .sticker-back.has-landscape .card-number {
    position: absolute;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
  }

  #open-pack {
    margin: 20px 0;
    padding: 16px 32px;
    font-size: 18px;
    background: #32cd32;
    color: #fff;
    border: none;
    cursor: pointer;
    border-radius: 8px;
    font-weight: bold;
    min-height: 56px;
    min-width: 250px;
    box-shadow: 0 4px 12px rgba(50, 205, 50, 0.3);
    transition: all 0.2s;
  }

  #open-pack:active {
    transform: scale(0.95);
    box-shadow: 0 2px 8px rgba(50, 205, 50, 0.3);
  }

  #open-pack.disabled {
    background: #ff3b3b;   /* RED */
    color: white;
    cursor: not-allowed;
    box-shadow: none;
  }


  #album, #duplicates {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #fff;
    overflow: auto;
    padding: 60px 20px 20px 20px;
    z-index: 100;
  }

  .album-grid, .duplicates-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 10px;
    margin-top: 20px;
    padding-bottom: 20px;
  }

  @media (min-width: 600px) {
    .album-grid, .duplicates-grid {
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    }
    
    header button {
      font-size: 16px;
    }
    
    #coins, #packs {
      font-size: 16px;
    }
    
    #open-pack {
      font-size: 20px;
    }
  }

  .album-slot, .duplicate-slot {
    width: 100%;
    height: 160px;
    border: 1px solid #888;
    background: #eee;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    font-size: 36px;
    color: #aaa;
    overflow: hidden;
    border-radius: 4px;
  }

  @media (min-width: 600px) {
    .album-slot, .duplicate-slot {
      height: 200px;
      font-size: 48px;
    }
  }

  .album-slot img, .duplicate-slot img {
    max-width: 100%;
    max-height: 120px;
    object-fit: contain;
    margin-bottom: 5px;
  }

  @media (min-width: 600px) {
    .album-slot img, .duplicate-slot img {
      max-height: 160px;
    }
  }

  .album-slot img.landscape, .duplicate-slot img.landscape {
    transform: rotate(90deg);
    max-width: 120px;
    max-height: 100px;
  }

  @media (min-width: 600px) {
    .album-slot img.landscape, .duplicate-slot img.landscape {
      max-width: 160px;
      max-height: 100px;
    }
  }

  .album-slot .slot-number, .duplicate-slot .slot-number {
    font-size: 12px;
    font-weight: bold;
  }

  .album-slot.has-landscape .slot-number,
  .duplicate-slot.has-landscape .slot-number {
    position: absolute;
    bottom: 5px;
    left: 50%;
    transform: translateX(-50%);
  }

  .close-btn {
    position: fixed;
    top: 10px;
    right: 10px;
    cursor: pointer;
    font-size: 24px;
    font-weight: bold;
    padding: 8px 16px;
    border: 1px solid #333;
    background: #ddd;
    border-radius: 4px;
    min-height: 44px;
    min-width: 44px;
    z-index: 101;
  }

  .close-btn:active {
    background: #ccc;
  }

  #sell-duplicates {
    position: sticky;
    bottom: 0;
    left: 0;
    right: 0;
    width: 100%;
    padding: 16px;
    font-size: 18px;
    background: #32cd32;
    color: white;
    border: none;
    cursor: pointer;
    font-weight: bold;
    margin-top: 20px;
    border-radius: 8px;
    min-height: 56px;
  }

  #sell-duplicates:active {
    background: #28a428;
  }

  h2 {
    margin: 0 0 10px 0;
    text-align: center;
  }
</style>
</head>

<body class="locked">

<div id="auth-box">
  <h2>Sticker Pack Game</h2>
  <p style="color: #666; text-align: center; margin-bottom: 20px; max-width: 300px;">
    Create an account or login to start collecting stickers!
  </p>
  <input type="text" id="username" placeholder="Username" required minlength="3" maxlength="20">
  <input type="password" id="password" placeholder="Password" required minlength="6">
  <button id="signup-btn" class="secondary">Sign Up</button>
  <button id="login-btn">Login</button>
  <div id="auth-status"></div>
</div>

<header>
  <button id="album-btn">üìñ ALBUM</button>
  <button id="duplicates-btn">üìÇ DUPES</button>
  <button id="save-btn">üíæ SAVE</button>
  <button id="reset-btn">üîÑ RESET</button>
  <div id="coins">üí∞ Coins: 100</div>
  <div id="packs">üì¶ Packs: 0</div>
  <button id="coin-flip">ü™ô Coin Flip</button>
  <button id="logout-btn" style="display: none;">üö™ Logout</button>
</header>

<div id="sticker-area"></div>

<button id="open-pack">üéÅ OPEN PACK (5 Coins)</button>

<div id="album">
  <div class="close-btn" onclick="document.getElementById('album').style.display='none'">‚úñ</div>
  <h2>Sticker Album</h2>
  <div id="album-count">Collected 0 / 700 stickers</div>
  <div class="album-grid" id="album-grid"></div>
</div>

<div id="duplicates">
  <div class="close-btn" onclick="document.getElementById('duplicates').style.display='none'">‚úñ</div>
  <h2>Duplicates</h2>
  <div class="duplicates-grid" id="duplicates-grid"></div>
  <button id="sell-duplicates">üí∞ Sell All Duplicates</button>
</div>

<script>

const supabaseUrl = "https://djpxosljltycswayletr.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqcHhvc2xqbHR5Y3N3YXlsZXRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5MTU5MjMsImV4cCI6MjA4NDQ5MTkyM30.bPesylaMS5wJSmHl3mIr2Ql3gAI5snULpBnBVdJYP2w";
const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

let packInProgress = false;

const STICKERS_TOTAL = 700;
let coins = 100;
let packsOpened = 0;
let flippedCount = 0;
const userCollection = [];
const duplicates = {};

const stickerArea = document.getElementById('sticker-area');
const coinsLabel = document.getElementById('coins');
const packsLabel = document.getElementById('packs');
const openPackBtn = document.getElementById('open-pack');
const authBox = document.getElementById("auth-box");
const statusText = document.getElementById("auth-status");

// Haptic feedback
function vibrate(duration = 10) {
  if ('vibrate' in navigator) {
    navigator.vibrate(duration);
  }
}

// Setup image rotation
function setupImageRotation(img, stickerNum, cardBack) {
  img.onload = function() {
    if (this.naturalWidth > this.naturalHeight) {
      this.classList.add('landscape');
      if (cardBack) {
        cardBack.classList.add('has-landscape');
      }
    }
  };
  img.onerror = function() {
    const parent = this.parentElement;
    parent.innerHTML = `<div style='font-size:60px;color:#333'>#${stickerNum}</div>`;
  };
}

// Helper function to generate unique email from username
function generateEmailFromUsername(username) {
  return `${username.toLowerCase().replace(/[^a-z0-9]/g, '')}@sticker.game`;
}

// Sign up with username
async function signUpWithUsername() {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value;

  if (!username || !password) {
    statusText.textContent = "Please enter username and password";
    statusText.style.color = "#ff6b6b";
    return;
  }

  if (username.length < 3) {
    statusText.textContent = "Username must be at least 3 characters";
    statusText.style.color = "#ff6b6b";
    return;
  }

  if (password.length < 6) {
    statusText.textContent = "Password must be at least 6 characters";
    statusText.style.color = "#ff6b6b";
    return;
  }

  const usernameRegex = /^[a-zA-Z0-9_]{3,20}$/;
  if (!usernameRegex.test(username)) {
    statusText.textContent = "Username can only contain letters, numbers, and underscores";
    statusText.style.color = "#ff6b6b";
    return;
  }

  statusText.textContent = "Creating account...";
  statusText.style.color = "#666";

  try {
    const email = generateEmailFromUsername(username);
    
    // Check if username already exists
    const { data: existingUser } = await supabaseClient
      .from('profiles')
      .select('username')
      .eq('username', username)
      .single();

    if (existingUser) {
      statusText.textContent = "Username already taken!";
      statusText.style.color = "#ff6b6b";
      return;
    }

    // Sign up with Supabase
    const { data, error } = await supabaseClient.auth.signUp({
      email,
      password,
      options: {
        data: {
          username: username,
          display_name: username
        }
      }
    });

    if (error) {
      if (error.message.includes("already registered")) {
        statusText.textContent = "Account already exists! Please login instead.";
      } else {
        statusText.textContent = error.message;
      }
      statusText.style.color = "#ff6b6b";
      return;
    }

    // Create profile entry
    if (data.user) {
      const { error: profileError } = await supabaseClient
        .from('profiles')
        .upsert({
          id: data.user.id,
          username: username,
          created_at: new Date().toISOString()
        });

      if (profileError) {
        statusText.textContent = "Error creating profile: " + profileError.message;
        statusText.style.color = "#ff6b6b";
        await supabaseClient.auth.signOut();
        return;
      }

      // Create initial save data
      await createInitialSave(data.user.id);
      
      statusText.textContent = `Welcome ${username}! Account created successfully!`;
      statusText.style.color = "#32cd32";
      
      setTimeout(() => {
        hideAuthBox();
        loadGame();
      }, 1500);
    }
  } catch (err) {
    statusText.textContent = "Error: " + err.message;
    statusText.style.color = "#ff6b6b";
  }
}

// Create initial save data
async function createInitialSave(userId) {
  const initialData = {
    id: userId,
    coins: 100,
    packs_opened: 0,
    collection: [],
    duplicates: {}
  };

  const { error } = await supabaseClient
    .from("saves")
    .upsert(initialData, { onConflict: 'id' });

  if (error) {
    console.error("Error creating initial save:", error);
  }
}

// Login with username
async function loginWithUsername() {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value;

  if (!username || !password) {
    statusText.textContent = "Please enter username and password";
    statusText.style.color = "#ff6b6b";
    return;
  }

  statusText.textContent = "Logging in...";
  statusText.style.color = "#666";

  try {
    const { data: profileData, error: profileError } = await supabaseClient
      .from('profiles')
      .select('username')
      .eq('username', username)
      .single();

    if (profileError || !profileData) {
      statusText.textContent = "Username not found!";
      statusText.style.color = "#ff6b6b";
      return;
    }

    const email = generateEmailFromUsername(username);
    
    const { error } = await supabaseClient.auth.signInWithPassword({
      email,
      password
    });

    if (error) {
      if (error.message.includes("Invalid login credentials")) {
        statusText.textContent = "Incorrect password!";
      } else {
        statusText.textContent = error.message;
      }
      statusText.style.color = "#ff6b6b";
    } else {
      statusText.textContent = `Welcome back ${username}!`;
      statusText.style.color = "#32cd32";
      
      setTimeout(() => {
        hideAuthBox();
        loadGame();
      }, 1000);
    }
  } catch (err) {
    statusText.textContent = "Error: " + err.message;
    statusText.style.color = "#ff6b6b";
  }
}

async function logout() {
  await supabaseClient.auth.signOut();
  location.reload();
}

function hideAuthBox() {
  authBox.style.display = "none";
  document.body.classList.remove("locked");
}

// Get current user's username
async function getCurrentUsername() {
  const { data: { user } } = await supabaseClient.auth.getUser();
  if (!user) return null;

  const { data } = await supabaseClient
    .from('profiles')
    .select('username')
    .eq('id', user.id)
    .single();

  return data?.username || user.email?.split('@')[0] || 'User';
}

// Update header to show username
async function updateUserDisplay() {
  const username = await getCurrentUsername();
  if (username) {
    let welcomeElement = document.getElementById('welcome-message');
    
    if (!welcomeElement) {
      welcomeElement = document.createElement('div');
      welcomeElement.id = 'welcome-message';
      welcomeElement.style.cssText = `
        font-weight: bold;
        padding: 8px 12px;
        background: white;
        border-radius: 4px;
        border: 1px solid #999;
        min-width: 120px;
        text-align: center;
      `;
      
      const packsDiv = document.getElementById('packs');
      if (packsDiv) {
        packsDiv.parentNode.insertBefore(welcomeElement, packsDiv.nextSibling);
      }
    }
    
    welcomeElement.textContent = `üëã ${username}`;
  }
}

// Save game function - FIXED
async function saveGame() {
  const { data: { user } } = await supabaseClient.auth.getUser();
  
  if (!user) {
    console.error("Cannot save: No user logged in");
    return false;
  }

  const data = {
    id: user.id,
    coins: coins,
    packs_opened: packsOpened,
    collection: userCollection, // This will be stored as JSONB array
    duplicates: duplicates, // This will be stored as JSONB object
    updated_at: new Date().toISOString()
  };

  console.log("Saving data:", data); // Debug log

  const { error } = await supabaseClient
    .from("saves")
    .upsert(data, { onConflict: 'id' });

  if (error) {
    console.error("Save failed:", error);
    alert("Failed to save game: " + error.message);
    return false;
  } else {
    console.log("Game saved to cloud successfully");
    return true;
  }
}

// Load game from Supabase - FIXED
async function loadGame() {
  const { data: { user } } = await supabaseClient.auth.getUser();
  
  if (!user) {
    authBox.style.display = "flex";
    document.body.classList.add("locked");
    return;
  }

  // Show logout button
  document.getElementById("logout-btn").style.display = "inline-block";
  
  // Load from Supabase
  const { data, error } = await supabaseClient
    .from("saves")
    .select("*")
    .eq("id", user.id)
    .single();

  if (error) {
    console.error("Load error:", error);
    
    // If no save exists, create one
    if (error.code === 'PGRST116') {
      console.log("No save found, creating initial save...");
      await createInitialSave(user.id);
    }
  } else if (data) {
    console.log("Loaded save data:", data); // Debug log
    
    // Load game data
    coins = data.coins ?? 100;
    packsOpened = data.packs_opened ?? 0;
    
    // Clear and reload collections
    userCollection.length = 0;
    if (data.collection && Array.isArray(data.collection)) {
      userCollection.push(...data.collection);
    }
    
    // Clear and reload duplicates
    for (let key in duplicates) delete duplicates[key];
    if (data.duplicates && typeof data.duplicates === 'object') {
      Object.assign(duplicates, data.duplicates);
    }
    
    console.log("Loaded collection:", userCollection);
    console.log("Loaded duplicates:", duplicates);
  }
  
  // Update user display and labels
  await updateUserDisplay();
  updateLabels();
}

// Coin flip game
async function coinFlipGame() {
  const { data: { user } } = await supabaseClient.auth.getUser();
  if (!user) {
    alert("Please login first!");
    return;
  }

  if (coins < 10) {
    alert("Not enough coins! Need 10 coins to play.");
    return;
  }

  coins -= 10;
  const win = Math.random() < 0.75;

  if (win) {
    coins += 25;
    alert("You won 25 coins! üéâ");
  } else {
    alert("You lost 10 coins üò≠");
  }

  updateLabels();
  await saveGame();
}

// Reset game
async function resetGame() {
  if (!confirm("Are you sure you want to reset your account? You'll lose all progress!")) {
    return;
  }

  coins = 100;
  packsOpened = 0;
  userCollection.length = 0;

  for (let key in duplicates) {
    delete duplicates[key];
  }

  updateLabels();
  stickerArea.innerHTML = '';

  openPackBtn.disabled = false;
  openPackBtn.classList.remove('disabled');
  openPackBtn.textContent = "üéÅ OPEN PACK (5 Coins)";
  packInProgress = false;


  const saved = await saveGame();
  if (saved) {
    vibrate(30);
    alert("Game reset successfully!");
  } else {
    alert("Failed to reset game!");
  }
}

// Update UI labels
function updateLabels() {
  coinsLabel.textContent = `üí∞ Coins: ${coins}`;
  packsLabel.textContent = `üì¶ Packs: ${packsOpened}`;
  openPackBtn.classList.toggle('disabled', coins < 5 || packInProgress);

}

// Get random stickers
function getRandomStickers(count) {
  const nums = Array.from({length: STICKERS_TOTAL}, (_, i) => i + 1);
  nums.sort(() => Math.random() - 0.5);
  return nums.slice(0, count);
}


async function openPack() {
  if (packInProgress) return;   // <-- HARD BLOCK

  const { data: { user } } = await supabaseClient.auth.getUser();
  if (!user) {
    alert("Please login first!");
    return;
  }

  if (coins < 5) {
    alert("Not enough coins!");
    return;
  }
  packInProgress = true;
  openPackBtn.disabled = true;
  openPackBtn.classList.add('disabled');   // <-- RED
  flippedCount = 0;
  openPackBtn.textContent = "üîí Flip all cards first";
  
  updateLabels()
  coins -= 5;
  packsOpened++;

  updateLabels()

  vibrate(50);

  stickerArea.innerHTML = '';
  const stickers = getRandomStickers(5);

  const centerX = stickerArea.offsetWidth / 2 - 80;
  const centerY = stickerArea.offsetHeight / 2 - 120;

  stickers.forEach((num, i) => {
    const card = document.createElement('div');
    card.className = 'sticker-card stacked';
    card.dataset.number = num;
    
    card.style.left = `${centerX + i * 2}px`;
    card.style.top = `${centerY + i * 2}px`;

    const img = document.createElement('img');
    img.src = `images/${num}.png`;
    img.alt = `Sticker #${num}`;

    card.innerHTML = `
      <div class="sticker-front">?</div>
      <div class="sticker-back">
        <div id="img-container-${num}"></div>
        <div class="card-number">#${num}</div>
      </div>
    `;

    const cardBack = card.querySelector('.sticker-back');
    setupImageRotation(img, num, cardBack);

    const imgContainer = card.querySelector(`#img-container-${num}`);
    imgContainer.appendChild(img);

    card.addEventListener('click', function flipCard() {
      if (!card.classList.contains('flipped')) {
        card.classList.add('flipped');
        vibrate(15);

        flippedCount++;

        if (flippedCount === 5) {
          packInProgress = false;

          if (coins >= 5) {
            openPackBtn.disabled = false;
            openPackBtn.classList.remove('disabled');
            openPackBtn.textContent = "üéÅ OPEN PACK (5 Coins)";
          } else {
            openPackBtn.disabled = true;
            openPackBtn.classList.add('disabled');
            openPackBtn.textContent = "‚ùå Not enough coins";
          }

          updateLabels(); // keeps UI in sync
        }

      }
    });



    stickerArea.appendChild(card);

    // Add to collection or duplicates
    if (userCollection.includes(num)) {
      duplicates[num] = (duplicates[num] || 0) + 1;
      console.log(`Duplicate found: #${num}, total: ${duplicates[num]}`);
    } else {
      userCollection.push(num);
      console.log(`New sticker: #${num}, total collection: ${userCollection.length}`);
    }
  });

  // Animate cards spreading
  setTimeout(() => {
    const cards = document.querySelectorAll('.sticker-card');
    const areaWidth = stickerArea.offsetWidth;
    const areaHeight = stickerArea.offsetHeight;
    
    const isMobile = areaWidth < 600;
    const cardsPerRow = isMobile ? Math.min(3, cards.length) : 5;
    
    cards.forEach((card, i) => {
      card.classList.remove('stacked');
      card.classList.add('spread');
      
      const row = Math.floor(i / cardsPerRow);
      const col = i % cardsPerRow;
      
      const cardWidth = 160;
      const cardHeight = 240;
      const spacing = isMobile ? 10 : 20;
      
      const totalWidth = cardsPerRow * cardWidth + (cardsPerRow - 1) * spacing;
      const startX = (areaWidth - totalWidth) / 2;
      const startY = (areaHeight - cardHeight) / 2 - row * (cardHeight / 2);
      
      const finalX = startX + col * (cardWidth + spacing);
      const finalY = Math.max(10, startY + row * (cardHeight + spacing));
      
      card.style.left = `${finalX}px`;
      card.style.top = `${finalY}px`;
    });
  }, 300);
  
  // Save after opening pack
  const saved = await saveGame();
  if (!saved) {
    console.error("Failed to save after opening pack!");
  }
}

// Album functions
function refreshAlbum() {
  const grid = document.getElementById('album-grid');
  const countLabel = document.getElementById('album-count');
  grid.innerHTML = '';

  const collectedCount = userCollection.length;
  countLabel.textContent = `Collected ${collectedCount} / ${STICKERS_TOTAL} stickers`;

  for (let i = 1; i <= STICKERS_TOTAL; i++) {
    const slot = document.createElement('div');
    slot.className = 'album-slot';

    if (userCollection.includes(i)) {
      const img = document.createElement('img');
      img.src = `images/${i}.png`;
      img.alt = `Sticker #${i}`;

      img.onload = function() {
        if (this.naturalWidth > this.naturalHeight) {
          this.classList.add('landscape');
          slot.classList.add('has-landscape');
        }
      };
      img.onerror = function() {
        const parent = this.parentElement;
        parent.innerHTML = `<div style='font-size:24px;color:#333'>#${i}</div>`;
      };

      slot.innerHTML = `<div class="slot-number">#${i}</div>`;
      slot.insertBefore(img, slot.firstChild);
    } else {
      slot.innerHTML = '?';
    }

    grid.appendChild(slot);
  }
}


// Duplicates functions
function refreshDuplicates() {
  const grid = document.getElementById('duplicates-grid');
  grid.innerHTML = '';
  
  const duplicateKeys = Object.keys(duplicates);
  console.log("Refreshing duplicates, count:", duplicateKeys.length); // Debug
  
  if (duplicateKeys.length === 0) {
    grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #999; padding: 40px;">No duplicates yet!</p>';
    return;
  }
  
  duplicateKeys.forEach(key => {
    const i = parseInt(key);
    const count = duplicates[key];
    
    const slot = document.createElement('div');
    slot.className = 'duplicate-slot';
    slot.style.position = 'relative';
    
    const img = document.createElement('img');
    img.src = `images/${i}.png`;
    img.alt = `Sticker #${i}`;
    
    img.onload = function() {
      if (this.naturalWidth > this.naturalHeight) {
        this.classList.add('landscape');
        slot.classList.add('has-landscape');
      }
    };
    img.onerror = function() {
      const parent = this.parentElement;
      parent.innerHTML = `<div style='font-size:24px;color:#333'>#${i}</div><div style="position: absolute; top: 5px; right: 5px; background: #ff6b6b; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold;">√ó${count}</div>`;
    };
    
    slot.innerHTML = `
      <div class="slot-number">#${i}</div>
      <div style="position: absolute; top: 5px; right: 5px; background: #ff6b6b; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">√ó${count}</div>
    `;
    slot.insertBefore(img, slot.firstChild);
    grid.appendChild(slot);
  });
}

// Initialize
async function initialize() {
  // Always show auth box on initial load
  authBox.style.display = "flex";
  document.body.classList.add("locked");
  
  // Check if user is already logged in
  const { data: { user } } = await supabaseClient.auth.getUser();
  if (user) {
    hideAuthBox();
    await loadGame();
  }
  
  // Set up event listeners
  document.getElementById('open-pack').addEventListener('click', openPack);
  document.getElementById('save-btn').addEventListener('click', async () => {
    const saved = await saveGame();
    if (saved) {
      alert('Game saved successfully!');
    } else {
      alert('Failed to save game!');
    }
  });
  
  document.getElementById('reset-btn').addEventListener('click', resetGame);
  document.getElementById('coin-flip').addEventListener('click', coinFlipGame);
  
  document.getElementById('album-btn').addEventListener('click', () => {
    document.getElementById('album').style.display = 'block';
    refreshAlbum();
    vibrate(10);
  });
  
  document.getElementById('duplicates-btn').addEventListener('click', () => {
    document.getElementById('duplicates').style.display = 'block';
    refreshDuplicates();
    vibrate(10);
  });
  
  document.getElementById('sell-duplicates').addEventListener('click', async () => {
    const duplicateKeys = Object.keys(duplicates);
    if (duplicateKeys.length === 0) {
      alert('No duplicates to sell!');
      return;
    }
    
    let totalDuplicates = 0;
    duplicateKeys.forEach(key => {
      totalDuplicates += duplicates[key];
    });
    
    coins += totalDuplicates;
    
    for (let key in duplicates) {
      delete duplicates[key];
    }
    
    updateLabels();
    refreshDuplicates();
    const saved = await saveGame();
    if (saved) {
      vibrate(50);
      alert(`Sold ${totalDuplicates} duplicates for ${totalDuplicates} coins!`);
    } else {
      alert("Failed to save after selling duplicates!");
    }
  });

  // Auth event listeners
  document.getElementById("login-btn").addEventListener("click", loginWithUsername);
  document.getElementById("signup-btn").addEventListener("click", signUpWithUsername);
  document.getElementById("logout-btn").addEventListener("click", logout);

  // Allow Enter key for login
  document.getElementById("username").addEventListener("keypress", (e) => {
    if (e.key === "Enter") loginWithUsername();
  });
  
  document.getElementById("password").addEventListener("keypress", (e) => {
    if (e.key === "Enter") loginWithUsername();
  });
}

// Initialize the app
initialize();
updateLabels();
</script>

<footer style="margin: 30px 0; font-size: 14px; text-align: center;">
  <a href="about.html">About</a> |
  <a href="privacy.html">Privacy Policy</a> |
  <a href="contact.html">Contact</a>
</footer>

</body>
</html>